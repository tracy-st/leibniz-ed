<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Text Search</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.6rem;
      font-weight: 600;
    }
    .subtitle {
      margin: 0 0 16px;
      font-size: 0.9rem;
      color: #666;
    }
    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }
    .search-bar input[type="text"] {
      flex: 1 1 220px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      outline: none;
    }
    .search-bar input[type="text"]:focus {
      border-color: #0070f3;
      box-shadow: 0 0 0 1px rgba(0, 112, 243, 0.15);
    }
    .search-bar label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      color: #444;
      user-select: none;
    }
    #status {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 10px;
      min-height: 1.2em;
    }
    #results {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .result {
      background: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.1s ease, box-shadow 0.1s ease;
    }
    .result:hover {
      background: #fafafa;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }
    .result-meta {
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 4px;
    }
    .result-text {
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    mark {
      background: #ffe58f;
      padding: 0 1px;
      border-radius: 2px;
    }
    .error {
      color: #b00020;
    }
    .muted {
      color: #999;
    }
    /* Line-numbered row */
.line-row {
  display: grid;
  grid-template-columns: 60px 1fr;
  gap: 12px;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}

.line-num {
  font-family: monospace;
  font-size: 0.8rem;
  text-align: right;
  color: #777;
  padding-right: 6px;
  user-select: none;
}

.line-text {
  white-space: pre-wrap;
  font-size: 0.95rem;
  line-height: 1.45;
}

  </style>
</head>
<body>
  <main>
    <h1>Search JSON Text</h1>
    <p class="subtitle">
      Searches across the <code>text</code> fields in <code>sample_entries.json</code>.
      Results show only the matching line; click to open the full entry.
    </p>

    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Type to search in text fields…"
        autocomplete="off"
      />
      <label>
        <input type="checkbox" id="caseSensitive" />
        Case sensitive
      </label>
    </div>

    <div id="status" class="muted">Loading data…</div>

    <ul id="results"></ul>
  </main>

  <script>
    let entries = [];

    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        q: params.get("q") || "",
        caseSensitive: params.get("cs") === "1",
      };
    }

    async function loadData() {
      const statusEl = document.getElementById("status");
      try {
        const res = await fetch("sample_entries.json");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        entries = await res.json();
        statusEl.textContent = "Data loaded. Type a search term to see results.";
        statusEl.classList.remove("muted");
      } catch (e) {
        console.error(e);
        statusEl.textContent =
          "Failed to load sample_entries.json. Ensure it is in the same folder and served over HTTP.";
        statusEl.classList.add("error");
      }
    }

    function normalize(text, caseSensitive) {
      return caseSensitive ? text : text.toLowerCase();
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, function (c) {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[c];
      });
    }

    function highlightFirst(text, query, caseSensitive) {
      if (!query) return escapeHtml(text);

      const normText = normalize(text, caseSensitive);
      const normQuery = normalize(query, caseSensitive);
      const idx = normText.indexOf(normQuery);

      if (idx === -1) {
        return escapeHtml(text);
      }

      const before = text.slice(0, idx);
      const match = text.slice(idx, idx + query.length);
      const after = text.slice(idx + query.length);

      return (
        escapeHtml(before) +
        "<mark>" +
        escapeHtml(match) +
        "</mark>" +
        escapeHtml(after)
      );
    }

    function getMatchedLine(fullText, query, caseSensitive) {
      if (!fullText) return "";
      const lines = fullText.split(/\r?\n/);
      const normQuery = normalize(query, caseSensitive);

      for (const line of lines) {
        if (normalize(line, caseSensitive).includes(normQuery)) {
          return line;
        }
      }
      for (const line of lines) {
        if (line.trim()) return line;
      }
      return lines[0] || "";
    }

    function renderResults(items, query, caseSensitive) {
      const list = document.getElementById("results");
      const status = document.getElementById("status");
      list.innerHTML = "";

      if (!query) {
        status.textContent = "Type a search term to see results.";
        status.classList.remove("error");
        status.classList.add("muted");
        return;
      }

      status.textContent =
        items.length === 0
          ? "No results."
          : items.length + " result" + (items.length === 1 ? "" : "s") + " found.";
      status.classList.remove("error");
      status.classList.remove("muted");

      items.forEach((item) => {
        const li = document.createElement("li");
        li.className = "result";

        const meta = document.createElement("div");
        meta.className = "result-meta";
        meta.textContent =
          (item.id || "∅ id") +
          " · " +
          (item.series || "∅ series") +
          " · seq " +
          (item.seq != null ? item.seq : "∅");

        const rawLine = getMatchedLine(fullText, query, caseSensitive);
const lineNum = extractLineNum(rawLine);
const cleanLine = stripLineNum(rawLine);

// Build sidebar row
const row = document.createElement("div");
row.className = "line-row";

const numEl = document.createElement("div");
numEl.className = "line-num";
numEl.textContent = lineNum || "";

const textEl = document.createElement("div");
textEl.className = "line-text";
textEl.innerHTML = highlightFirst(cleanLine, query, caseSensitive);

row.appendChild(numEl);
row.appendChild(textEl);
li.appendChild(row);

        const fullText = item.text || "";
        const line = getMatchedLine(fullText, query, caseSensitive);
        // Extract a line number, e.g., [[4.16]]
function extractLineNum(line) {
  const m = line.match(/\[\[(.*?)]]/);
  return m ? m[1] : "";
}

// Remove [[4.16]] from the displayed text
function stripLineNum(line) {
  return line.replace(/\[\[(.*?)]]\s*/, "");
}


        li.appendChild(meta);
        li.appendChild(textDiv);

        li.addEventListener("click", () => {
          const params = new URLSearchParams({
            id: item.id != null ? String(item.id) : "",
            q: query,
            cs: caseSensitive ? "1" : "0",
          });
          window.location.href = "detail.html?" + params.toString();
        });

        list.appendChild(li);
      });
    }

    function setupSearch(initialQuery, initialCaseSensitive) {
      const input = document.getElementById("searchInput");
      const caseBox = document.getElementById("caseSensitive");

      function onSearch() {
        const q = input.value.trim();
        const caseSensitive = caseBox.checked;

        if (!q) {
          renderResults([], q, caseSensitive);
          return;
        }

        const normQuery = normalize(q, caseSensitive);

        const filtered = entries.filter((e) => {
          const text = e.text || "";
          return normalize(text, caseSensitive).includes(normQuery);
        });

        renderResults(filtered, q, caseSensitive);
      }

      input.addEventListener("input", onSearch);
      caseBox.addEventListener("change", onSearch);

      // Initialize from URL params, if present
      if (initialQuery) {
        input.value = initialQuery;
      }
      caseBox.checked = !!initialCaseSensitive;

      // If there is an initial query, perform an initial search
      if (initialQuery) {
        onSearch();
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const { q, caseSensitive } = getParams();
      await loadData();
      setupSearch(q, caseSensitive);
    });
  </script>
</body>
</html>
