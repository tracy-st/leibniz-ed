<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Series Index</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <span class="sidebar-title">Navigation</span>
          <button id="sidebarCollapseBtn" class="sidebar-collapse-btn" type="button">
            ⟨
          </button>
        </div>
        <nav class="sidebar-nav">
          <a href="search.html" data-page="search">Search</a>
          <a href="browse.html" data-page="index">Series Index</a>
        </nav>
      </div>
    </aside>

    <main>
      <button id="sidebarExpandBtn" class="sidebar-expand-btn" type="button">
        ☰
      </button>

      <h1>Series Index</h1>
      <p class="subtitle">
        Browse all entries grouped by <code>series</code>. Each entry shows its title,
        sequence, number, and date, and links to the detail view.
      </p>

      <div id="seriesContainer"></div>
    </main>
  </div>

  <script>
    async function loadIndex() {
      const container = document.getElementById("seriesContainer");

      let entries;
      try {
        const res = await fetch("sample_entries.json");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        entries = await res.json();
      } catch (e) {
        console.error(e);
        container.textContent =
          "Failed to load sample_entries.json. Ensure it is in the same folder and served over HTTP.";
        return;
      }

      // Group by series
      const bySeries = new Map();
      for (const e of entries) {
        const series = e.series || "(no series)";
        if (!bySeries.has(series)) bySeries.set(series, []);
        bySeries.get(series).push(e);
      }

      const seriesNames = Array.from(bySeries.keys()).sort((a, b) =>
        a.localeCompare(b)
      );

      for (const series of seriesNames) {
        const section = document.createElement("section");
        section.className = "series-block collapsed"; // start collapsed

        // Header with toggle button
        const header = document.createElement("button");
        header.type = "button";
        header.className = "series-toggle";
        header.setAttribute("aria-expanded", "false");

        const arrow = document.createElement("span");
        arrow.className = "series-arrow";
        arrow.textContent = "▶";

        const label = document.createElement("span");
        label.className = "series-label";
        label.textContent = series;

        header.appendChild(arrow);
        header.appendChild(label);

        header.addEventListener("click", () => {
          const collapsed = section.classList.toggle("collapsed");
          header.setAttribute("aria-expanded", String(!collapsed));
        });

        section.appendChild(header);

        // List of entries in this series
        const list = document.createElement("ul");
        list.className = "index-list";

        const items = bySeries.get(series).slice().sort((a, b) => {
          const sa = a.seq != null ? Number(a.seq) : Number.POSITIVE_INFINITY;
          const sb = b.seq != null ? Number(b.seq) : Number.POSITIVE_INFINITY;
          if (sa !== sb) return sa - sb;
          return String(a.id).localeCompare(String(b.id));
        });

        for (const item of items) {
          const li = document.createElement("li");
          li.className = "index-entry";

          const a = document.createElement("a");
          a.className = "index-link";
          a.href = "detail.html?id=" + encodeURIComponent(String(item.id));

          const titleDiv = document.createElement("div");
          titleDiv.className = "index-title";

          const number = item.number != null ? String(item.number).trim() : "";
          const title = item.title || item.id || "(untitled)";
          const heading = (number ? number + " " : "") + title;
          titleDiv.textContent = heading;

          const metaDiv = document.createElement("div");
          metaDiv.className = "index-meta";
          const seqText = item.seq != null ? item.seq : "∅";
          const numText = number || "∅";
          const dateText = item.date || "∅";

          metaDiv.textContent =
            "Seq: " + seqText + " · No: " + numText + " · Date: " + dateText;

          a.appendChild(titleDiv);
          a.appendChild(metaDiv);
          li.appendChild(a);
          list.appendChild(li);
        }

        section.appendChild(list);
        container.appendChild(section);
      }
    }

    function setupSidebar(currentPageKey) {
      const collapseBtn = document.getElementById("sidebarCollapseBtn");
      const expandBtn = document.getElementById("sidebarExpandBtn");
      const navLinks = document.querySelectorAll(".sidebar-nav a");

      function setActiveLink() {
        navLinks.forEach((link) => {
          const page = link.getAttribute("data-page");
          if (page === currentPageKey) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      function collapse() {
        document.body.classList.add("sidebar-collapsed");
      }

      function expand() {
        document.body.classList.remove("sidebar-collapsed");
      }

      if (collapseBtn) collapseBtn.addEventListener("click", collapse);
      if (expandBtn) expandBtn.addEventListener("click", expand);

      setActiveLink();
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await loadIndex();
      setupSidebar("index");
    });
  </script>
</body>
</html>
