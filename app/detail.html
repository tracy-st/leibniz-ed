<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Entry Detail</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-header">
           <span class="sidebar-title"></span>
           <div class="nav-button">
                <button id="sidebarExpandBtn" class="sidebar-expand-btn" type="button">
                    ☰
                </button>
                <button id="sidebarCollapseBtn" class="sidebar-collapse-btn" type="button">
                    ☰
                </button>
           </div>
        </div>
        <nav class="sidebar-nav">
          <a href="search.html" data-page="search">Search</a>
          <a href="browse.html" data-page="index">Series Index</a>
        </nav>
      </div>
    </aside>

    <main>

      <div class="detail-header">
  <a id="backLink" class="btn" href="search.html">
    <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        d="M10.5 3L5 8l5.5 5"
        fill="none"
        stroke="currentColor"
        stroke-linecap="round"
        stroke-width="1.4"
      />
    </svg>
    Back to search results
  </a>

  <label class="line-toggle-label">
    <input type="checkbox" id="toggleLineNumbersDetail" checked />
    Show line numbers
  </label>

  <!-- NEW: HTML render toggle, default ON -->
  <label class="html-toggle-label">
    <input type="checkbox" id="toggleRenderHtml" checked />
    Render HTML
  </label>
</div>

      <h1 id="detailTitle">Entry</h1>
      <div id="detailMeta"></div>
      <div id="status"></div>
      
      <div id="detailText"></div>
    </main>
  </div>

  <script>
    let lineIndex = {};
    let renderHtml = true;

    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        id: params.get("id") || "",
        q: params.get("q") || "",
        caseSensitive: params.get("cs") === "1",
      };
    }

    function getHashLine() {
      const raw = window.location.hash || "";
      if (!raw) return "";
      return decodeURIComponent(raw.slice(1));
    }

   function escapeHtml(str) {
  return str.replace(/[&<>"']/g, function (c) {
    return {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[c];
  });
}

function normalize(text, caseSensitive) {
  return caseSensitive ? text : text.toLowerCase();
}

/**
 * @param {string}  text         Original text (may contain HTML)
 * @param {string}  query        Search string to highlight
 * @param {boolean} caseSensitive
 * @param {boolean} renderHtml   true = render HTML; false = escape HTML
 */
function highlightAll(text, query, caseSensitive, renderHtml) {
  const process = (s) => (renderHtml ? s : escapeHtml(s));

  if (!query) return process(text);

  const normText = normalize(text, caseSensitive);
  const normQuery = normalize(query, caseSensitive);
  if (!normQuery) return process(text);

  let result = "";
  let i = 0;

  while (true) {
    const idx = normText.indexOf(normQuery, i);
    if (idx === -1) {
      result += process(text.slice(i));
      break;
    }

    // text before match
    result += process(text.slice(i, idx));

    // matched part
    const matched = text.slice(idx, idx + query.length);
    result += "<mark>" + process(matched) + "</mark>";

    i = idx + query.length;
  }

  return result;
}


    function extractLineNum(line) {
      const m = line.match(/\[\[(.*?)]]/);
      return m ? m[1] : "";
    }

    function stripLineNum(line) {
      return line.replace(/\[\[(.*?)]]\s*/, "");
    }

    // Fallback extractors for number/title/date from the text markup
    function extractNumberFromText(text) {
      const m = text.match(/<nr>\s*(.*?)\s*<\/nr>/);
      return m ? m[1] : "";
    }

    function extractTitleFromText(text) {
      const m = text.match(/<tit>(.*?)<\/tit>/);
      return m ? m[1] : "";
    }

    function extractDateFromText(text) {
      const m = text.match(/<dat>(.*?)<\/dat>/);
      return m ? m[1] : "";
    }

    // Strip inline markup from a title-like string
    function stripMarkup(str) {
      if (!str) return "";
      return str
        .replace(/<[^>]+>/g, "")   // remove all tags
        .replace(/\s+/g, " ")      // collapse whitespace
        .trim();
    }

    // Title-case with Latin-friendly small words
    function toTitleCaseLatin(str) {
      if (!str) return "";
      const smallWords = new Set([
        "de","et","ad","in","ex","cum","sub","per","a","an","the",
        "of","for","to","or","nor"
      ]);
      const lower = str.toLowerCase();
      const words = lower.split(" ");
      const cased = words.map((w, i) => {
        if (!w) return "";
        if (i > 0 && smallWords.has(w)) {
          return w; // keep small word lowercase (not first)
        }
        return w.charAt(0).toUpperCase() + w.slice(1);
      });
      return cased.join(" ").trim();
    }

    // Full normalization pipeline for titles
    function normalizeTitle(raw) {
      const stripped = stripMarkup(raw);
      if (!stripped) return "";
      return toTitleCaseLatin(stripped);
    }

    function clearActiveLine() {
      document.querySelectorAll(".line-row.active-line").forEach((row) => {
        row.classList.remove("active-line");
      });
    }

    function activateLineByNumber(lineNum, scroll = false) {
      if (!lineNum || !lineIndex[lineNum]) return;
      clearActiveLine();
      const row = lineIndex[lineNum];
      row.classList.add("active-line");
      if (scroll) {
        row.scrollIntoView({ block: "center" });
      }
    }

    async function loadEntry() {
      const { id, q, caseSensitive } = getParams();
      const statusEl = document.getElementById("status");
      const titleEl = document.getElementById("detailTitle");
      const metaEl = document.getElementById("detailMeta");
      const textContainer = document.getElementById("detailText");

      if (!id) {
        statusEl.textContent = "Missing id parameter.";
        statusEl.classList.add("error");
        return;
      }

      try {
        statusEl.textContent = "Loading data…";
        const res = await fetch("sample_entries.json");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const entries = await res.json();
        const entry = entries.find((e) => String(e.id) === String(id));

        if (!entry) {
          statusEl.textContent = "Entry not found for id: " + id;
          statusEl.classList.add("error");
          return;
        }

        statusEl.textContent = q
          ? `Showing full text for "${id}" with matches for "${q}".`
          : `Showing full text for "${id}".`;

        const full = entry.text || "";

        // Prefer explicit JSON fields; fall back to parsing from text
        const number =
          (entry.number != null && String(entry.number).trim() !== "")
            ? String(entry.number).trim()
            : extractNumberFromText(full);

        const rawTitle =
          (entry.title != null && String(entry.title).trim() !== "")
            ? String(entry.title)
            : extractTitleFromText(full);

        const normalizedTitle = normalizeTitle(rawTitle) || entry.id || "Entry";

        const date =
          (entry.date != null && String(entry.date).trim() !== "")
            ? String(entry.date).trim()
            : extractDateFromText(full);

        // Heading: "19 De Possibilitate Gratiae Divinae" (no trailing period)
        const heading = (number ? number + " " : "") + normalizedTitle;
        titleEl.textContent = heading;

        // Meta line: Date + ID + Series + Seq
        const metaParts = [];
        if (date) metaParts.push("Date: " + date);
        metaParts.push("ID: " + (entry.id || "∅"));
        metaParts.push("Series: " + (entry.series || "∅"));
        metaParts.push("Seq: " + (entry.seq != null ? entry.seq : "∅"));
        metaEl.textContent = metaParts.join(" · ");

        const lines = full.split(/\r?\n/);

        textContainer.innerHTML = "";
        lineIndex = {};

        lines.forEach((line) => {
          if (!line.trim()) return;

          const ln = extractLineNum(line);
          const row = document.createElement("div");
          row.className = "line-row";
          if (ln) {
            row.id = "line-" + ln;
          }

          const numEl = document.createElement("div");
          numEl.className = "line-num";
          numEl.textContent = ln || "";
          if (ln) {
            numEl.classList.add("line-num-clickable");
            numEl.title = "Click to link to line " + ln;
            numEl.addEventListener("click", (ev) => {
                ev.stopPropagation();

                const hash = "line-" + encodeURIComponent(ln);

                // Update only the hash in the browser location bar
                const newUrl = location.href.replace(/#.*/, "") + "#" + hash;
                history.replaceState(null, "", "#" + hash);

                // Copy the full URL including ?id=... and #line-...
                navigator.clipboard.writeText(newUrl).catch(() => {});

                activateLineByNumber(ln, false);
                });

          }

          const textEl = document.createElement("div");
textEl.className = "line-text";
textEl.innerHTML = highlightAll(stripLineNum(line), q, caseSensitive, renderHtml);


          row.appendChild(numEl);
          row.appendChild(textEl);
          textContainer.appendChild(row);

          if (ln) {
            lineIndex[ln] = row;
          }
        });

        const hashLine = getHashLine();
        if (hashLine && lineIndex[hashLine]) {
          activateLineByNumber(hashLine, true);
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent =
          "Failed to load sample_entries.json. Ensure it is in the same folder and served over HTTP.";
        statusEl.classList.add("error");
      }
    }

    function setupBackLink() {
      const { q, caseSensitive } = getParams();
      const back = document.getElementById("backLink");
      const params = new URLSearchParams();

      if (q) params.set("q", q);
      if (caseSensitive) params.set("cs", "1");

      back.href = "search.html" + (params.toString() ? "?" + params.toString() : "");
    }

    function setupLineToggle() {
      const toggle = document.getElementById("toggleLineNumbersDetail");
      const applyState = () => {
        if (toggle.checked) {
          document.body.classList.remove("lines-hidden");
        } else {
          document.body.classList.add("lines-hidden");
        }
      };
      toggle.addEventListener("change", applyState);
      applyState();
    }

    function setupHtmlRenderToggle() {
  const toggle = document.getElementById("toggleRenderHtml");
  if (!toggle) return;

  // Initialize from checkbox state (checked by default)
  renderHtml = toggle.checked;

  toggle.addEventListener("change", () => {
    renderHtml = toggle.checked;
    loadEntry(); // re-render entry with new mode
  });
}


    function setupHashListener() {
      window.addEventListener("hashchange", () => {
        const ln = getHashLine();
        if (ln) {
          activateLineByNumber(ln, true);
        }
      });
    }

    function setupSidebar(currentPageKey) {
      const collapseBtn = document.getElementById("sidebarCollapseBtn");
      const expandBtn = document.getElementById("sidebarExpandBtn");
      const navLinks = document.querySelectorAll(".sidebar-nav a");

      function setActiveLink() {
        navLinks.forEach((link) => {
          const page = link.getAttribute("data-page");
          if (page === currentPageKey) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      function collapse() {
        document.body.classList.add("sidebar-collapsed");
      }

      function expand() {
        document.body.classList.remove("sidebar-collapsed");
      }

      if (collapseBtn) collapseBtn.addEventListener("click", collapse);
      if (expandBtn) expandBtn.addEventListener("click", expand);

      if (currentPageKey) {
        setActiveLink();
      }
    }
   window.addEventListener("DOMContentLoaded", async () => {
  setupBackLink();
  setupLineToggle();
  setupHashListener();
  setupSidebar(null); // no active nav item for detail page
  setupHtmlRenderToggle(); // NEW
  await loadEntry();
});

  </script>
</body>
</html>
