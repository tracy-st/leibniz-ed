<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Text Search</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.6rem;
      font-weight: 600;
    }

    .subtitle {
      margin: 0 0 16px;
      font-size: 0.9rem;
      color: #666;
    }

    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    .search-bar input[type="text"] {
      flex: 1 1 220px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      outline: none;
    }

    .search-bar input[type="text"]:focus {
      border-color: #0070f3;
      box-shadow: 0 0 0 1px rgba(0, 112, 243, 0.15);
    }

    .search-bar label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      color: #444;
      user-select: none;
    }

    #status {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 10px;
      min-height: 1.2em;
    }

    #results {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .result {
      background: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.1s ease, box-shadow 0.1s ease;
    }

    .result:hover {
      background: #fafafa;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .result-meta {
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 4px;
    }

    .result-text {
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    mark {
      background: #ffe58f;
      padding: 0 1px;
      border-radius: 2px;
    }

    .error {
      color: #b00020;
    }

    .muted {
      color: #999;
    }

    /* Views */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Detail view */
    #detailMeta {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 8px;
    }

    #detailText {
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.5;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      padding: 12px 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f9f9fb;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }

    .btn:hover {
      background: #f0f0f3;
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }
  </style>
</head>
<body>
  <main>
    <!-- SEARCH VIEW -->
    <section id="searchView" class="view active">
      <h1>Search JSON Text</h1>
      <p class="subtitle">
        Searches across the <code>text</code> fields in <code>sample_entries.json</code>.
        Results show only the matching line; click to open the full entry.
      </p>

      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          placeholder="Type to search in text fields…"
          autocomplete="off"
        />
        <label>
          <input type="checkbox" id="caseSensitive" />
          Case sensitive
        </label>
      </div>

      <div id="status" class="muted">Loading data…</div>

      <ul id="results"></ul>
    </section>

    <!-- DETAIL VIEW -->
    <section id="detailView" class="view">
      <button id="backButton" class="btn" type="button">
        <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
          <path d="M10.5 3L5 8l5.5 5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.4"/>
        </svg>
        Back to search
      </button>

      <h1 id="detailTitle" style="margin-top:16px; margin-bottom:8px;">Entry</h1>
      <div id="detailMeta"></div>
      <div id="detailText"></div>
    </section>
  </main>

  <script>
    let entries = [];
    const entryById = new Map();

    async function loadData() {
      const statusEl = document.getElementById("status");
      try {
        const res = await fetch("sample_entries.json");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        entries = await res.json();
        entries.forEach(e => {
          if (e && e.id != null) {
            entryById.set(String(e.id), e);
          }
        });
        statusEl.textContent = "Data loaded. Type a search term to see results.";
      } catch (e) {
        console.error(e);
        statusEl.textContent =
          "Failed to load sample_entries.json. Ensure it is in the same folder and served over HTTP.";
        statusEl.classList.add("error");
      }
    }

    function normalize(text, caseSensitive) {
      return caseSensitive ? text : text.toLowerCase();
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, function (c) {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[c];
      });
    }

    // Highlight first match in a single line
    function highlightFirst(text, query, caseSensitive) {
      if (!query) return escapeHtml(text);

      const normText = normalize(text, caseSensitive);
      const normQuery = normalize(query, caseSensitive);
      const idx = normText.indexOf(normQuery);

      if (idx === -1) {
        return escapeHtml(text);
      }

      const before = text.slice(0, idx);
      const match = text.slice(idx, idx + query.length);
      const after = text.slice(idx + query.length);

      return (
        escapeHtml(before) +
        "<mark>" +
        escapeHtml(match) +
        "</mark>" +
        escapeHtml(after)
      );
    }

    // Highlight all matches in full text
    function highlightAll(text, query, caseSensitive) {
      if (!query) return escapeHtml(text);

      const normText = normalize(text, caseSensitive);
      const normQuery = normalize(query, caseSensitive);
      if (!normQuery) return escapeHtml(text);

      let result = "";
      let i = 0;

      while (true) {
        const idx = normText.indexOf(normQuery, i);
        if (idx === -1) {
          result += escapeHtml(text.slice(i));
          break;
        }
        result += escapeHtml(text.slice(i, idx));
        result += "<mark>" + escapeHtml(text.slice(idx, idx + query.length)) + "</mark>";
        i = idx + query.length;
      }

      return result;
    }

    // Get the single line (first occurrence) containing the query
    function getMatchedLine(fullText, query, caseSensitive) {
      if (!fullText) return "";
      const lines = fullText.split(/\r?\n/);
      const normQuery = normalize(query, caseSensitive);

      for (const line of lines) {
        if (normalize(line, caseSensitive).includes(normQuery)) {
          return line;
        }
      }
      // Fallback: if no specific line found (should not happen if filtering is correct),
      // show the first non-empty line or first line.
      for (const line of lines) {
        if (line.trim()) return line;
      }
      return lines[0] || "";
    }

    function renderResults(items, query, caseSensitive) {
      const list = document.getElementById("results");
      const status = document.getElementById("status");
      list.innerHTML = "";

      if (!query) {
        status.textContent = "Type a search term to see results.";
        status.classList.remove("error");
        status.classList.add("muted");
        return;
      }

      status.textContent =
        items.length === 0
          ? "No results."
          : items.length + " result" + (items.length === 1 ? "" : "s") + " found.";
      status.classList.remove("error");
      status.classList.remove("muted");

      items.forEach((item) => {
        const li = document.createElement("li");
        li.className = "result";
        li.dataset.id = item.id != null ? String(item.id) : "";

        const meta = document.createElement("div");
        meta.className = "result-meta";
        meta.textContent =
          (item.id || "∅ id") +
          " · " +
          (item.series || "∅ series") +
          " · seq " +
          (item.seq != null ? item.seq : "∅");

        const textDiv = document.createElement("div");
        textDiv.className = "result-text";
        const fullText = item.text || "";
        const line = getMatchedLine(fullText, query, caseSensitive);
        textDiv.innerHTML = highlightFirst(line, query, caseSensitive);

        li.appendChild(meta);
        li.appendChild(textDiv);
        list.appendChild(li);
      });
    }

    function showView(id) {
      document.querySelectorAll(".view").forEach((el) => {
        el.classList.remove("active");
      });
      const target = document.getElementById(id);
      if (target) target.classList.add("active");
    }

    function showDetail(entry, query, caseSensitive) {
      const titleEl = document.getElementById("detailTitle");
      const metaEl = document.getElementById("detailMeta");
      const textEl = document.getElementById("detailText");

      titleEl.textContent = entry.id || "Entry";
      metaEl.textContent =
        "ID: " +
        (entry.id || "∅") +
        " · Series: " +
        (entry.series || "∅") +
        " · Seq: " +
        (entry.seq != null ? entry.seq : "∅");

      const fullText = entry.text || "";
      textEl.innerHTML = highlightAll(fullText, query, caseSensitive);

      showView("detailView");
    }

    function setupSearch() {
      const input = document.getElementById("searchInput");
      const caseBox = document.getElementById("caseSensitive");
      const resultsList = document.getElementById("results");
      const backButton = document.getElementById("backButton");

      function onSearch() {
        const q = input.value.trim();
        const caseSensitive = caseBox.checked;

        if (!q) {
          renderResults([], q, caseSensitive);
          return;
        }

        const normQuery = normalize(q, caseSensitive);

        const filtered = entries.filter((e) => {
          const text = e.text || "";
          return normalize(text, caseSensitive).includes(normQuery);
        });

        renderResults(filtered, q, caseSensitive);
      }

      input.addEventListener("input", onSearch);
      caseBox.addEventListener("change", onSearch);

      // Click on result → open detail view
      resultsList.addEventListener("click", (event) => {
        const li = event.target.closest(".result");
        if (!li) return;
        const id = li.dataset.id;
        if (!id) return;

        const entry = entryById.get(id);
        if (!entry) return;

        const q = input.value.trim();
        const caseSensitive = caseBox.checked;
        showDetail(entry, q, caseSensitive);
      });

      // Back to search
      backButton.addEventListener("click", () => {
        showView("searchView");
      });
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await loadData();
      setupSearch();
    });
  </script>
</body>
</html>
